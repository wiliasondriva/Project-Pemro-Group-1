---
title: "Visualisasi Data Tugas Pemro"
author: "Kelompok 1"
date: "`r Sys.Date()`"
output: html_document
---

## Analisis Data Eksploratif (EDA)

### 1. Setup Awal

```{r}
# Memuat library yang diperlukan
library(knitr)    
library(ggplot2)  
library(tidyr)
library(readxl)
library(dplyr)
library(sf)               
library(stringr)          
library(ggsflabel)        
library(viridis) 
# 1. MEMUAT DATA
data_final <- read_excel("data_final_bersih.xlsx")
head(data_final)
kab_indo <- st_read("D:/Kuliah/Statistika IPB/Semester 1/Sains Data/Praktikum/data-spasial-sains-data/Admin2Kabupaten/idn_admbnda_adm2_bps_20200401.shp")
kab_indo
jabar_kabkot <- kab_indo %>%
  filter(ADM1_EN == "Jawa Barat") %>%
  select(ADM2_EN, ADM2_PCODE, geometry)
jabar_kabkot
```

### 2. Analisis Data Eksploratif (EDA)

#### Statistik Deskriptif

Pertama, akan melihat ringkasan statistik dasar untuk semua variabel. Fungsi summary() akan memberi kita Min (Minimum), Median, Mean (Rata-rata), dan Max (Maksimum). Untuk Varians, kita perlu menghitungnya secara terpisah.

```{r}
# 2. Statistik deskriptif dasar (Min, Median, Mean, Max, Kuartil)
summary(data_final)

# 3. Menghitung Varians
varians_data <- data_final %>%
  select(where(is.numeric)) %>%  # Memilih hanya kolom numerik
  summarise(across(everything(), ~ var(.x, na.rm = TRUE))) %>%
  # Merapikan tabel untuk dibaca
  pivot_longer(everything(), names_to = "Variabel", values_to = "Varians")
kable(varians_data, caption = "Varians untuk Setiap Variabel Numerik")
```

#### Visualisasi Data (ggplot2)

##### Histogram Variabel Respon (Jumlah Kejahatan)

Histogram dibuat untuk melihat distribusi dari variabel respon, yaitu Jumlah Kejahatan yang Dilaporkan. Ini membantu kita melihat apakah datanya skewed (miring) atau tidak.

```{r}
# Membuat histogram untuk 'Jumlah Kejahatan yang Dilaporkan'
ggplot(data_final, aes(x = `Jumlah Kejahatan yang Dilaporkan`)) +
  geom_histogram(bins = 10, fill = "#0072B2", color = "black", alpha = 0.7) +
  labs(
    title = "Distribusi Jumlah Kejahatan yang Dilaporkan",
    x = "Jumlah Kejahatan",
    y = "Frekuensi (Jumlah Polres)"
  ) +
  theme_minimal()
```

Penjelasan: Dari histogram ini, kita bisa melihat bahwa sebagian besar Polres memiliki jumlah kejahatan di angka yang rendah, namun ada beberapa Polres dengan jumlah kejahatan yang sangat tinggi (ekor di sebelah kanan). Ini disebut right-skewed.

##### Boxplot Distribusi Variabel

Boxplot berguna untuk melihat rentang data (dari min ke max), interquartile range (IQR), median, dan mendeteksi outlier. Scaling (standardisasi) perlu dilakukan terlebih dahulu untuk membandingkan distribusi semua variabel, karena satuannya berbeda-beda (misal Upah dalam jutaan, Pengangguran hanya satuan).

```{r}
# 1. Menyiapkan data: Pilih numerik -> scaling -> ubah ke format 'long'
data_scaled_long <- data_final %>%
  select(where(is.numeric)) %>%
  scale() %>% # Scaling data (Z-score)
  as.data.frame() %>%
  pivot_longer(everything(), names_to = "Variabel", values_to = "Nilai_Terskala")

# 2. Membuat boxplot
ggplot(data_scaled_long, aes(x = Variabel, y = Nilai_Terskala)) +
  geom_boxplot(fill = "lightblue", outlier.color = "red") +
  coord_flip() + # Memutar plot agar label variabel mudah dibaca
  labs(
    title = "Boxplot Variabel Numerik (Setelah Scaling)",
    x = "Variabel",
    y = "Nilai Terskala (Z-score)"
  ) +
  theme_bw()
```

Penjelasan: Boxplot ini menunjukkan perbandingan sebaran data untuk setiap variabel. Kita bisa melihat bahwa variabel seperti Produk Domestik Regional Bruto dan Besaran Upah Minimum memiliki beberapa nilai outlier (titik merah) di sisi atas.

##### Scatter Plot (Hubungan Antar Variabel)

Terakhir, scatter plot dibuat untuk melihat hubungan antara variabel predictor (sosial ekonomi) dengan variabel response (Jumlah Kejahatan). Agar efisien, kita akan menggunakan pivot_longer() untuk merapikan data, lalu facet_wrap() untuk membuat semua plot dalam satu gambar.

```{r}
# 1. Ubah data ke format 'long'
# Kita pisahkan variabel Sosial ekonomi (prediktor) dan Kejahatan (respon)
data_plot_long <- data_final %>%
  pivot_longer(
    cols = -c(`Satuan_Wilayah_Hukum`, `Jumlah Kejahatan yang Dilaporkan`),
    names_to = "Variabel_Sosek",
    values_to = "Nilai"
  )

# 2. Membuat scatter plot dengan facet_wrap
ggplot(data_plot_long, aes(x = Nilai, y = `Jumlah Kejahatan yang Dilaporkan`)) +
  geom_point(color = "#D55E00", alpha = 0.8) +
  geom_smooth(method = "lm", se = FALSE, color = "blue", linetype = "dashed") +
  # facet_wrap sangat penting di sini
  # scales = "free_x" mengizinkan sumbu X memiliki skala berbeda-beda
  facet_wrap(~ Variabel_Sosek, scales = "free_x", ncol = 3) +
  labs(
    title = "Hubungan Antara Jumlah Kejahatan dan Variabel Sosek",
    x = "Nilai Variabel Sosial Ekonomi",
    y = "Jumlah Kejahatan"
  ) +
  theme_bw()
```

Penjelasan : Grafik: Setiap kotak adalah scatter plot antara satu variabel sosek (sumbu X) dan Jumlah Kejahatan (sumbu Y). Garis Biru: Ini adalah garis regresi linear.

Interpretasi Awal: Jika garis naik (positif), seperti pada kepadatan_penduduk atau besaran_upah_minimum, artinya ada indikasi awal: semakin tinggi nilai variabel itu, semakin tinggi pula jumlah kejahatannya. Jika garis datar atau turun (negatif), hubungannya mungkin lemah atau berbanding terbalik.

### 3. Visualisasi Peta Spasial (Choropleth Map)

Terakhir, visualisasi peta (choropleth map) untuk melihat sebaran geografis dari tingkat kriminalitas. Ini akan menggabungkan data shapefile (peta administrasi) dengan data kriminalitas data_final yang sudah disiapkan.
```{r}
# 1. Membuat "Kamus" Pemetaan Wilayah
# Ini adalah langkah krusial untuk memetakan 27 Kab/Kota (dari Peta)
# ke data Polres (dari data_final)
mapping_polres <- tibble::tribble(
  ~ADM2_EN, ~Satuan_Wilayah_Hukum,
  "Bogor", "Polres Bogor",
  "Kota Bogor", "Polresta Kota Bogor",
  "Sukabumi", "Polres Sukabumi",
  "Kota Sukabumi", "Polres Kota Sukabumi",
  "Cianjur", "Polres Cianjur",
  "Bandung", "Polresta Bandung",
  "Kota Bandung", "Polrestabes Kota Bandung",
  "Bandung Barat", "Polres Cimahi",         
  "Cimahi", "Polres Cimahi",            
  "Garut", "Polres Garut",
  "Tasikmalaya", "Polres Tasikmalaya",
  "Kota Tasikmalaya", "Polres Kota Tasikmalaya",
  "Ciamis", "Polres Ciamis",
  "Banjar", "Polres Kota Banjar",            
  "Pangandaran", "Polres Pangandaran",        
  "Kuningan", "Polres Kuningan",
  "Cirebon", "Polresta Cirebon",
  "Kota Cirebon", "Polres Kota Cirebon",
  "Majalengka", "Polres Majalengka",
  "Sumedang", "Polres Sumedang",
  "Indramayu", "Polres Indramayu",
  "Subang", "Polres Subang",
  "Purwakarta", "Polres Purwakarta",
  "Karawang", "Polres Karawang",
  "Bekasi", "Polresta Bandung",
  "Kota Bekasi", "Polresta Bandung",
  "Depok", "Polresta Bandung"
)

# 2. Menggabungkan Data
# Langkah 1: Gabungkan Peta Jabar (jabar_kabkot) dengan Kamus Mapping (mapping_polres)
jabar_mapped <- jabar_kabkot %>%
  left_join(mapping_polres, by = "ADM2_EN")

# Langkah 2: Gabungkan hasil (jabar_mapped) dengan Data Kriminalitas (data_final)
jabar_peta_final <- jabar_mapped %>%
  left_join(data_final, by = "Satuan_Wilayah_Hukum")

# Cek hasil akhir
kable(head(as.data.frame(jabar_peta_final)))
```

Penjelasan: Data jabar_peta_final kini adalah data spasial (peta) yang sudah memiliki kolom-kolom numerik dari data_final (Jumlah Kejahatan, upah, dll). Wilayah seperti Kab. Bandung Barat dan Kota Cimahi sekarang akan merujuk ke data "Polres Cimahi" yang sama.
```{r}
# 3. Membuat Plot Peta

# Mendefinisikan breaks (rentang nilai) untuk legenda.
min_crime <- min(jabar_peta_final$`Jumlah Kejahatan yang Dilaporkan`, na.rm = TRUE)
max_crime <- max(jabar_peta_final$`Jumlah Kejahatan yang Dilaporkan`, na.rm = TRUE)
crime_breaks <- round(seq(min_crime, max_crime, length.out = 6))

# Membuat plot
peta_kriminalitas <- jabar_peta_final %>%
  ggplot() +
  # 1. Lapisan Peta (geom_sf)
  geom_sf(aes(fill = `Jumlah Kejahatan yang Dilaporkan`), color = "white", size = 0.2) +
  
  # 2. Lapisan Label (dari ggsflabel)
  ggsflabel::geom_sf_label_repel(
    aes(label = str_wrap(ADM2_EN, width = 10)),
    size = 2.5,          # Ukuran font label
    fill = "white",
    alpha = 0.7,
    segment.color = "grey50",
    max.overlaps = 15
  ) +
  
  # 3. Skala Warna (Color Scale)
  scale_fill_stepsn(
    colors = viridis::magma(n = 6, direction = -1),
    breaks = crime_breaks,
    n.breaks = 6,
    guide = guide_colorsteps(
      title.position = "top",
      barwidth = 15,
      barheight = 0.7
    )
  ) +
  
  # 4. Tema dan Judul
  theme_bw() +
  labs(
    title = "Peta Sebaran Kriminalitas di Jawa Barat",
    subtitle = "Berdasarkan Satuan Wilayah Hukum (Polres/Polresta/Polrestabes)",
    fill = "Jumlah Kejahatan (Laporan)",
    caption = "Sumber Data: BPS dan Instansi Terkait"
  ) +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "bottom",
    legend.title.align = 0.5
  )

# Tampilkan plot
print(peta_kriminalitas)
```

Penjelasan: Peta ini menunjukkan sebaran jumlah kejahatan yang dilaporkan. Wilayah dengan warna yang lebih terang (mendekati kuning) memiliki jumlah laporan kejahatan yang lebih rendah. Wilayah gabungan seperti Cimahi dan Bandung Barat memiliki warna yang identik, sesuai dengan data data_final.

